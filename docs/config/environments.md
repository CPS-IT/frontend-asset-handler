# Environments

## Config reference

### `merge`

Define whether to merge the given environment map with the default
map provided by [`MapFactory::createDefault()`](../../src/Asset/Environment/Map/MapFactory.php).

* Required: **no**
* Default: **`false`**

### `map`

Set a custom mapping to resolve local branches to asset environments.
This is useful if you need to extend the default map by custom needs
or exchange various branch configurations within the default map.

The configuration is transformed to a [`Map`](../../src/Asset/Environment/Map/Map.php)
object, generated by [`MapFactory::crateFromArray()`](../../src/Asset/Environment/Map/MapFactory.php).
Each mapping must include a branch pattern and a corresponding
configuration for an [environment transformer](../components/environment-transformers.md).

:bulb: The branch pattern can be either a regular expression with
delimiter `/` or any other string that is processable by the
[`fnmatch`][1] function.

* Required: **no**
* Default: **–**

```json
{
    "environments": {
        "map": {
            "<branch pattern>": {
                "transformer": "<transformer type>",
                "options": "<transformer options>"
            }
        }
    }
}
```

## Branch determination logic

The branch used for mapping the frontend environment is determined by the following logic:

| Priority | Logic                | Description                                                      |
|----------|----------------------|------------------------------------------------------------------|
| 1.       | Environment variable | Determination via environment variable `$FRONTEND_ASSETS_BRANCH` |
| 2.       | CI                   | Determination via [`ondram/ci-detector`][2] package              |
| 3.       | Git                  | Determination via command `git symbolic-ref --short HEAD`        |

## Environment resolving

Frontend assets are stored in asset environments and must also be requested through them.
In order to identify which asset environment should be requested, a mapping takes place
between the local development branch and the asset environment. This is done with the
help of the [`EnvironmentResolver`](../../src/Asset/Environment/EnvironmentResolver.php) which
is fed by a [`Map`](../../src/Asset/Environment/Map/Map.php).

The default map generated by [`MapFactory::createDefault()`](../../src/Asset/Environment/Map/MapFactory.php)
resolves to the following mapping table:

| Branch               | Environment                      | Fallback |
|----------------------|----------------------------------|----------|
| `main`               | [`{version}`](source.md#version) | `stable` |
| `master`             | [`{version}`](source.md#version) | `stable` |
| `develop`            | `latest`                         | –        |
| `release/*`          | `latest`                         | –        |
| `feature/*`          | `fe-{slug}`                      | –        |
| `preview`            | `preview`                        | –        |
| `integration`        | `integration`                    | –        |
| `*.*.*`<sup>1)</sup> | `{branch}`<sup>1)</sup>          | –        |

_<sup>1)</sup> If a specific version number is given, then exactly this version number is
also requested as the asset environment. In this case, no mapping takes place._

> :bulb: You can extend or completely exchange the default map by your needs.

[1]: https://www.php.net/manual/en/function.fnmatch.php
[2]: https://packagist.org/packages/ondram/ci-detector
